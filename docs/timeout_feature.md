# æ¸¸æˆè¶…æ—¶å¤„ç†åŠŸèƒ½æ–‡æ¡£

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

æ¸¸æˆè¶…æ—¶å¤„ç†åŠŸèƒ½ç¡®ä¿æ¸¸æˆæµç¨‹ä¸ä¼šå› ä¸ºç©å®¶é•¿æ—¶é—´ä¸å“åº”è€Œå¡æ­»ã€‚å½“æŠ•ç¥¨æˆ–ä»»åŠ¡é˜¶æ®µè¶…æ—¶æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä¸ºæœªå“åº”çš„ç©å®¶éšæœºæ‰§è¡Œæ“ä½œã€‚

---

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

### 1. è‡ªåŠ¨æŠ•ç¥¨è¶…æ—¶
- **è§¦å‘æ¡ä»¶**: ç©å®¶åœ¨æŠ•ç¥¨é˜¶æ®µï¼ˆTEAM_VOTEï¼‰è¶…è¿‡ `timeout_seconds` ç§’æœªæŠ•ç¥¨
- **è¶…æ—¶æ—¶é—´**: é»˜è®¤ 60 ç§’ï¼ˆå¯åœ¨ GameState.timeout_seconds ä¸­é…ç½®ï¼‰
- **è‡ªåŠ¨è¡Œä¸º**: ä¸ºæœªæŠ•ç¥¨çš„ç©å®¶éšæœºæŠ•ç¥¨
  - **å¥½é˜µè¥**ï¼ˆMERLIN, PERCIVAL, LOYALï¼‰: 70% æ¦‚ç‡æŠ• "yes"ï¼Œ30% æ¦‚ç‡æŠ• "no"
  - **åé˜µè¥**ï¼ˆMORGANA, ASSASSIN, MORDRED, MINION, OBERONï¼‰: 60% æ¦‚ç‡æŠ• "no"ï¼Œ40% æ¦‚ç‡æŠ• "yes"

### 2. è‡ªåŠ¨ä»»åŠ¡è¶…æ—¶
- **è§¦å‘æ¡ä»¶**: ç©å®¶åœ¨ä»»åŠ¡æ‰§è¡Œé˜¶æ®µï¼ˆQUEST_PERFORMï¼‰è¶…è¿‡ `timeout_seconds` ç§’æœªæ‰§è¡Œ
- **è¶…æ—¶æ—¶é—´**: é»˜è®¤ 60 ç§’ï¼ˆå¯åœ¨ GameState.timeout_seconds ä¸­é…ç½®ï¼‰
- **è‡ªåŠ¨è¡Œä¸º**: ä¸ºæœªæ‰§è¡Œçš„ç©å®¶éšæœºæ‰§è¡Œä»»åŠ¡
  - **å¥½é˜µè¥**: å¿…é¡»é€‰æ‹© "success"
  - **åé˜µè¥**: 40% æ¦‚ç‡é€‰æ‹© "fail"ï¼Œ60% æ¦‚ç‡é€‰æ‹© "success"

### 3. å…¶ä»–é˜¶æ®µ
ä»¥ä¸‹é˜¶æ®µ**ä¸è§¦å‘**è¶…æ—¶å¤„ç†ï¼š
- `TEAM_SELECTION`ï¼ˆç»„é˜Ÿé˜¶æ®µï¼‰: ç”±é˜Ÿé•¿æ“ä½œï¼Œæ— è¶…æ—¶é™åˆ¶
- `ASSASSINATION`ï¼ˆåˆºæ€é˜¶æ®µï¼‰: ç”±åˆºå®¢æ“ä½œï¼Œæ— è¶…æ—¶é™åˆ¶
- `GAME_OVER`ï¼ˆæ¸¸æˆç»“æŸï¼‰: ä¸éœ€è¦è¶…æ—¶å¤„ç†

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ•°æ®åº“æ¨¡å‹

```python:src/models/sql_models.py
class GameState(db.Model):
    # ... å…¶ä»–å­—æ®µ ...
    
    phase_start_time = db.Column(db.DateTime, default=datetime.utcnow)  # é˜¶æ®µå¼€å§‹æ—¶é—´
    timeout_seconds = db.Column(db.Integer, default=60)  # è¶…æ—¶ç§’æ•°
```

### è¶…æ—¶æ£€æµ‹æœåŠ¡

```python:src/services/timeout_service.py
class TimeoutService:
    def check_and_process_timeouts(self):
        """å®šæœŸæ£€æŸ¥æ‰€æœ‰æ¸¸æˆçš„è¶…æ—¶çŠ¶æ€"""
        
    def _handle_vote_timeout(self, room):
        """å¤„ç†æŠ•ç¥¨è¶…æ—¶ï¼šè‡ªåŠ¨éšæœºæŠ•ç¥¨"""
        
    def _handle_quest_timeout(self, room):
        """å¤„ç†ä»»åŠ¡è¶…æ—¶ï¼šè‡ªåŠ¨éšæœºæ‰§è¡Œ"""
```

### åå°ä»»åŠ¡

```python:src/app_factory.py
def _start_timeout_checker():
    """å¯åŠ¨åå°çº¿ç¨‹ï¼Œæ¯ 10 ç§’æ£€æŸ¥ä¸€æ¬¡è¶…æ—¶"""
    while True:
        timeout_service.check_and_process_timeouts()
        time.sleep(10)
```

---

## ğŸ“Š å·¥ä½œæµç¨‹

### æŠ•ç¥¨è¶…æ—¶æµç¨‹

```
1. é˜Ÿé•¿ç»„é˜Ÿå®Œæˆ
   â†“
2. è¿›å…¥ TEAM_VOTE é˜¶æ®µï¼Œè®°å½• phase_start_time
   â†“
3. ç©å®¶å¼€å§‹æŠ•ç¥¨...
   â†“
4. åå°ä»»åŠ¡æ¯ 10 ç§’æ£€æŸ¥ä¸€æ¬¡è¶…æ—¶
   â†“
5. æ£€æµ‹åˆ°è¶…æ—¶ï¼ˆ> 60 ç§’ï¼‰
   â†“
6. ä¸ºæœªæŠ•ç¥¨çš„ç©å®¶éšæœºæŠ•ç¥¨
   - å¥½äºº: 70% yes, 30% no
   - åäºº: 60% no, 40% yes
   â†“
7. ç»Ÿè®¡æŠ•ç¥¨ç»“æœï¼Œè¿›å…¥ä¸‹ä¸€é˜¶æ®µ
```

### ä»»åŠ¡è¶…æ—¶æµç¨‹

```
1. æŠ•ç¥¨é€šè¿‡ï¼Œè¿›å…¥ QUEST_PERFORM é˜¶æ®µ
   â†“
2. è®°å½• phase_start_time
   â†“
3. ä»»åŠ¡é˜Ÿå†…çš„ç©å®¶å¼€å§‹æ‰§è¡Œ...
   â†“
4. åå°ä»»åŠ¡æ¯ 10 ç§’æ£€æŸ¥ä¸€æ¬¡è¶…æ—¶
   â†“
5. æ£€æµ‹åˆ°è¶…æ—¶ï¼ˆ> 60 ç§’ï¼‰
   â†“
6. ä¸ºæœªæ‰§è¡Œçš„ç©å®¶éšæœºæ‰§è¡Œ
   - å¥½äºº: å¿…é¡» success
   - åäºº: 40% fail, 60% success
   â†“
7. ç»Ÿè®¡ä»»åŠ¡ç»“æœï¼Œè¿›å…¥ä¸‹ä¸€é˜¶æ®µ
```

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. æ•°æ®åº“è¿ç§»

ç”±äºæ–°å¢äº†æ•°æ®åº“å­—æ®µï¼Œéœ€è¦è¿è¡Œè¿ç§»ï¼š

```bash
# å¼€å‘ç¯å¢ƒ
flask db migrate -m "Add timeout fields to game_state"
flask db upgrade

# ç”Ÿäº§ç¯å¢ƒ
flask db upgrade
```

### 2. é…ç½®è¶…æ—¶æ—¶é—´

é»˜è®¤è¶…æ—¶æ—¶é—´ä¸º 60 ç§’ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼é…ç½®ï¼š

**æ–¹å¼ 1: ä¿®æ”¹æ¨¡å‹é»˜è®¤å€¼**
```python
# src/models/sql_models.py
class GameState(db.Model):
    timeout_seconds = db.Column(db.Integer, default=120)  # ä¿®æ”¹ä¸º 120 ç§’
```

**æ–¹å¼ 2: è¿è¡Œæ—¶åŠ¨æ€è®¾ç½®**
```python
# src/services/game_service.py
def start_game(self, room_number: str, operator_openid: str, timeout: int = 60):
    room.game_state.timeout_seconds = timeout
    # ...
```

### 3. æ‰‹åŠ¨æ£€æŸ¥è¶…æ—¶

```bash
# ä½¿ç”¨ Flask CLI å‘½ä»¤æ‰‹åŠ¨æ£€æŸ¥
flask check-timeouts
```

### 4. åå°ä»»åŠ¡

åå°ä»»åŠ¡ä¼šåœ¨åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨è¿è¡Œï¼Œæ— éœ€æ‰‹åŠ¨å¹²é¢„ã€‚

**æ£€æŸ¥ä»»åŠ¡æ˜¯å¦è¿è¡Œ**ï¼š
```python
# æŸ¥çœ‹æ—¥å¿—
tail -f logs/app.log | grep "Timeout checker"
```

**é¢„æœŸæ—¥å¿—**ï¼š
```
âœ… Timeout checker background thread started
```

---

## ğŸ”§ é…ç½®é€‰é¡¹

### æ£€æŸ¥é—´éš”

åœ¨ `timeout_service.py` ä¸­ä¿®æ”¹ï¼š

```python
class TimeoutService:
    def __init__(self):
        self.check_interval = 10  # æ¯ 10 ç§’æ£€æŸ¥ä¸€æ¬¡
```

### è¶…æ—¶æ—¶é—´

åœ¨æ•°æ®åº“æ¨¡å‹ä¸­ä¿®æ”¹ï¼š

```python
class GameState(db.Model):
    timeout_seconds = db.Column(db.Integer, default=60)  # é»˜è®¤ 60 ç§’
```

### è‡ªåŠ¨æŠ•ç¥¨æ¦‚ç‡

åœ¨ `timeout_service.py` ä¸­ä¿®æ”¹ï¼š

```python
# æŠ•ç¥¨è¶…æ—¶
if role in ['MERLIN', 'PERCIVAL', 'LOYAL']:
    vote = 'yes' if random.random() < 0.7 else 'no'  # 70% yes
else:
    vote = 'no' if random.random() < 0.6 else 'yes'  # 60% no

# ä»»åŠ¡è¶…æ—¶
if role in ['MERLIN', 'PERCIVAL', 'LOYAL']:
    vote = 'success'  # å¥½äººå¿…é¡»æˆåŠŸ
else:
    vote = 'fail' if random.random() < 0.4 else 'success'  # 40% fail
```

---

## ğŸ“ æ—¥å¿—ç¤ºä¾‹

### æ­£å¸¸è¶…æ—¶å¤„ç†

```
[INFO] Room 1234 timeout in phase TEAM_VOTE (elapsed: 65.2s, timeout: 60s)
[INFO] Auto-vote for player 3 (LOYAL): yes (timeout)
[INFO] Auto-vote for player 4 (MORGANA): no (timeout)
[INFO] Team vote FAILED in room 1234. Next leader idx: 1
```

### ä»»åŠ¡è¶…æ—¶å¤„ç†

```
[INFO] Room 5678 timeout in phase QUEST_PERFORM (elapsed: 70.5s, timeout: 60s)
[INFO] Auto-quest for player 2 (ASSASSIN): fail (timeout)
[INFO] Auto-quest for player 3 (LOYAL): success (timeout)
[INFO] Quest 3 result: FAIL (Fails: 1)
```

---

## ğŸ§ª æµ‹è¯•

### å•å…ƒæµ‹è¯•

```bash
# è¿è¡Œè¶…æ—¶æœåŠ¡æµ‹è¯•
pytest tests/unit/test_timeout_service.py -v
```

### é›†æˆæµ‹è¯•

1. åˆ›å»ºä¸€ä¸ª 5 äººæˆ¿é—´
2. å¼€å§‹æ¸¸æˆ
3. åœ¨æŠ•ç¥¨é˜¶æ®µç­‰å¾… 60+ ç§’ä¸æ“ä½œ
4. éªŒè¯ç³»ç»Ÿè‡ªåŠ¨æŠ•ç¥¨

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ•°æ®åº“è¿ç§»
- **å¿…é¡»**è¿è¡Œ `flask db upgrade` æ¥æ·»åŠ æ–°å­—æ®µ
- ç°æœ‰çš„ `phase_start_time` å­—æ®µä¼šè‡ªåŠ¨è®¾ç½®ä¸ºå½“å‰æ—¶é—´

### 2. åå°ä»»åŠ¡
- åå°ä»»åŠ¡ä½¿ç”¨ daemon çº¿ç¨‹ï¼Œåº”ç”¨é€€å‡ºæ—¶ä¼šè‡ªåŠ¨åœæ­¢
- åœ¨å¼€å‘ç¯å¢ƒä¸­ä½¿ç”¨ `--reload` å¯åŠ¨æ—¶ï¼Œåå°ä»»åŠ¡å¯èƒ½ä¼šå¤šæ¬¡å¯åŠ¨ï¼ˆè¿™æ˜¯æ­£å¸¸çš„ï¼‰

### 3. æ€§èƒ½å½±å“
- åå°ä»»åŠ¡æ¯ 10 ç§’æ£€æŸ¥ä¸€æ¬¡æ‰€æœ‰è¿›è¡Œä¸­çš„æ¸¸æˆ
- å¯¹äºæ¸¸æˆæ•°é‡ < 1000 çš„åœºæ™¯ï¼Œæ€§èƒ½å½±å“å¯ä»¥å¿½ç•¥
- å¦‚æœæ¸¸æˆæ•°é‡å¾ˆå¤§ï¼Œå»ºè®®è°ƒæ•´æ£€æŸ¥é—´éš”æˆ–ä¼˜åŒ–æŸ¥è¯¢

### 4. è¶…æ—¶æ—¶é—´è®¾ç½®
- å»ºè®®è¶…æ—¶æ—¶é—´è®¾ç½®ä¸º 60-120 ç§’
- å¤ªçŸ­ï¼šå¯èƒ½å¯¼è‡´ç©å®¶æ¥ä¸åŠå“åº”
- å¤ªé•¿ï¼šæ¸¸æˆä½“éªŒå˜å·®

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: åå°ä»»åŠ¡æœªå¯åŠ¨

**ç—‡çŠ¶**: è¶…æ—¶ä¸ç”Ÿæ•ˆ

**æ£€æŸ¥æ–¹æ³•**:
```bash
# æŸ¥çœ‹æ—¥å¿—
grep "Timeout checker" logs/app.log
```

**è§£å†³æ–¹æ¡ˆ**:
ç¡®ä¿åœ¨ `app_factory.py` ä¸­è°ƒç”¨äº† `_start_timeout_checker()`

### é—®é¢˜ 2: è¶…æ—¶æ—¶é—´ä¸å‡†ç¡®

**ç—‡çŠ¶**: è¶…æ—¶æ—¶é—´è¿‡å¿«æˆ–è¿‡æ…¢

**æ£€æŸ¥æ–¹æ³•**:
```python
# æŸ¥è¯¢æ•°æ®åº“
SELECT room_number, phase, phase_start_time, timeout_seconds 
FROM game_states 
JOIN rooms ON game_states.room_id = rooms.id 
WHERE status = 'PLAYING';
```

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥ `timeout_seconds` å­—æ®µå€¼
- ç¡®ä¿æœåŠ¡å™¨æ—¶é—´æ­£ç¡®

### é—®é¢˜ 3: è‡ªåŠ¨æŠ•ç¥¨ä¸ç¬¦åˆé¢„æœŸ

**ç—‡çŠ¶**: è‡ªåŠ¨æŠ•ç¥¨ç»“æœä¸åˆç†

**æ£€æŸ¥æ–¹æ³•**:
- æŸ¥çœ‹æ—¥å¿—ä¸­çš„éšæœºæŠ•ç¥¨è®°å½•
- æ£€æŸ¥è§’è‰²åˆ†é…æ˜¯å¦æ­£ç¡®

**è§£å†³æ–¹æ¡ˆ**:
- è°ƒæ•´è‡ªåŠ¨æŠ•ç¥¨æ¦‚ç‡é…ç½®
- éªŒè¯è§’è‰²è¯†åˆ«é€»è¾‘

---

## ğŸ“ˆ ç›‘æ§æŒ‡æ ‡

### å»ºè®®ç›‘æ§çš„æŒ‡æ ‡

1. **è¶…æ—¶å‘ç”Ÿç‡**: `è¶…æ—¶æ¬¡æ•° / æ€»æ“ä½œæ¬¡æ•°`
2. **å¹³å‡è¶…æ—¶æ—¶é—´**: å¹³å‡çš„è¶…æ—¶æ—¶é•¿
3. **è‡ªåŠ¨æŠ•ç¥¨åˆ†å¸ƒ**: yes/no çš„æ¯”ä¾‹
4. **è‡ªåŠ¨ä»»åŠ¡åˆ†å¸ƒ**: success/fail çš„æ¯”ä¾‹

### æ—¥å¿—ç›‘æ§

```bash
# ç›‘æ§è¶…æ—¶äº‹ä»¶
tail -f logs/app.log | grep "timeout"

# ç»Ÿè®¡è¶…æ—¶æ¬¡æ•°
grep "timeout" logs/app.log | wc -l
```

---

## ğŸ“ æœ€ä½³å®è·µ

### 1. å¼€å‘ç¯å¢ƒ
- å°†è¶…æ—¶æ—¶é—´è®¾ç½®ä¸ºè¾ƒé•¿ï¼ˆå¦‚ 300 ç§’ï¼‰ï¼Œä¾¿äºæµ‹è¯•
- ä½¿ç”¨ `flask check-timeouts` æ‰‹åŠ¨è§¦å‘è¶…æ—¶æ£€æŸ¥

### 2. ç”Ÿäº§ç¯å¢ƒ
- ä¿æŒè¶…æ—¶æ—¶é—´ä¸º 60 ç§’
- ç›‘æ§è¶…æ—¶å‘ç”Ÿç‡ï¼Œå¦‚æœ‰å¼‚å¸¸åŠæ—¶è°ƒæ•´
- å®šæœŸæ¸…ç†åƒµå°¸æ¸¸æˆ

### 3. æµ‹è¯•ç¯å¢ƒ
- ä½¿ç”¨ mock æµ‹è¯•éªŒè¯è¶…æ—¶é€»è¾‘
- è¦†ç›–å„ç§è¶…æ—¶åœºæ™¯

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Redis Cache-Aside å®ç°](./redis_cache_implementation.md)
- [éƒ¨ç½²æ–‡æ¡£](./deployment.md)
- [README](../README.md)

---

## âœ… å®ç°æ¸…å•

- [x] æ•°æ®åº“æ¨¡å‹æ›´æ–°ï¼ˆphase_start_time, timeout_secondsï¼‰
- [x] è¶…æ—¶æ£€æµ‹æœåŠ¡å®ç°
- [x] æŠ•ç¥¨è¶…æ—¶å¤„ç†é€»è¾‘
- [x] ä»»åŠ¡è¶…æ—¶å¤„ç†é€»è¾‘
- [x] åå°ä»»åŠ¡å¯åŠ¨
- [x] é˜¶æ®µåˆ‡æ¢æ—¶æ›´æ–°è¶…æ—¶æ—¶é—´
- [x] Flask CLI å‘½ä»¤ï¼ˆcheck-timeoutsï¼‰
- [x] å•å…ƒæµ‹è¯•
- [x] æ–‡æ¡£ç¼–å†™

---

**çŠ¶æ€**: âœ… å®Œæˆ  
**ç‰ˆæœ¬**: v1.0  
**ä½œè€…**: AI Assistant  
**æ—¥æœŸ**: 2024-01-13
