# 游戏超时功能数据库迁移说明

## 📋 迁移概述

由于游戏超时功能需要在 `game_states` 表中新增两个字段，需要进行数据库迁移。

---

## 🔄 迁移步骤

### 1. 生成迁移脚本

```bash
# 在项目根目录执行
flask db migrate -m "Add timeout fields to game_state"

# 这将生成类似这样的文件：
# migrations/versions/xxxxx_add_timeout_fields_to_game_state.py
```

### 2. 审查生成的迁移脚本

检查生成的迁移脚本内容，确保包含以下操作：

```python
def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('game_states', sa.Column('phase_start_time', sa.DateTime(), nullable=True))
    op.add_column('game_states', sa.Column('timeout_seconds', sa.Integer(), nullable=True))
    # ### end Alembic commands ###

def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column('game_states', 'timeout_seconds')
    op.drop_column('game_states', 'phase_start_time')
    # ### end Alembic commands ###
```

### 3. 应用迁移

```bash
# 应用迁移到数据库
flask db upgrade
```

### 4. 验证迁移结果

```sql
-- 检查新字段是否添加成功
DESCRIBE game_states;

-- 或者查看表结构
SHOW COLUMNS FROM game_states;

-- 预期输出应包含：
-- phase_start_time: datetime
-- timeout_seconds: int(11)
```

---

## 🗄️ 字段说明

### phase_start_time
- **类型**: DATETIME
- **默认值**: CURRENT_TIMESTAMP（自动设置）
- **说明**: 记录当前游戏阶段开始的时间，用于计算是否超时
- **用途**: 在阶段切换时更新，用于超时检测

### timeout_seconds
- **类型**: INT
- **默认值**: 60
- **说明**: 超时时间（秒），可配置
- **用途**: 决定玩家在投票/任务阶段的最长响应时间

---

## 🔧 迁移后的默认值处理

迁移后，现有记录的字段值：

### phase_start_time
- **现有记录**: 默认为 `NULL`
- **处理方式**: 在下一次阶段切换时自动更新为当前时间
- **影响**: 现有游戏不会立即触发超时，直到进入下一个阶段

### timeout_seconds
- **现有记录**: 默认为 `NULL`
- **处理方式**: 代码中会使用默认值 60
- **影响**: 使用默认超时时间 60 秒

---

## ⚠️ 注意事项

### 1. 迁移前备份

**重要**: 在执行迁移前，建议备份数据库！

```bash
# MySQL 备份
mysqldump -u root -p avalon_db > backup_before_timeout_migration.sql

# Docker 环境备份
docker exec avalon-mysql mysqldump -u root -p root_password avalon_db > backup.sql
```

### 2. 检查迁移版本

```bash
# 查看当前迁移版本
flask db current

# 查看迁移历史
flask db history
```

### 3. 回滚迁移（如有必要）

如果迁移出现问题，可以回滚：

```bash
# 回滚到上一个版本
flask db downgrade
```

---

## 🧪 测试迁移

### 1. 开发环境测试

```bash
# 1. 备份测试数据库
# 2. 执行迁移
flask db upgrade
# 3. 运行测试
pytest tests/
# 4. 验证功能正常
```

### 2. 生产环境测试

```bash
# 1. 在生产环境的备用数据库上执行迁移
# 2. 运行完整的回归测试
# 3. 确认无误后在主数据库执行
```

---

## 📊 影响评估

### 数据库变更
- **新增字段**: 2 个
- **表结构变更**: 1 个表（game_states）
- **迁移时间**: 预计 < 1 秒（取决于数据量）

### 应用程序影响
- **兼容性**: 向后兼容，现有代码可正常运行
- **性能影响**: 几乎无影响（仅新增两个字段）
- **功能影响**: 启用超时检测功能

### 运行时影响
- **零停机**: 迁移可在应用运行时执行
- **零数据丢失**: 仅新增字段，不修改现有数据

---

## ✅ 迁移检查清单

- [ ] 备份数据库
- [ ] 生成迁移脚本
- [ ] 审查迁移脚本内容
- [ ] 在开发环境测试迁移
- [ ] 在生产环境备用数据库测试
- [ ] 执行生产环境迁移
- [ ] 验证字段添加成功
- [ ] 验证超时功能正常工作
- [ ] 监控应用日志

---

## 🔍 故障排查

### 问题 1: 迁移失败

**症状**: `flask db upgrade` 报错

**常见原因**:
- 数据库连接失败
- 权限不足
- 表已被锁定

**解决方案**:
1. 检查数据库连接配置
2. 确认数据库用户有 ALTER TABLE 权限
3. 检查是否有长时间运行的查询锁定了表

### 问题 2: 字段未添加

**症状**: 迁移成功但字段不存在

**检查方法**:
```sql
DESCRIBE game_states;
```

**解决方案**:
```bash
# 检查迁移版本
flask db current

# 检查迁移是否执行
flask db show <revision_id>

# 手动添加字段（仅限紧急情况）
ALTER TABLE game_states ADD COLUMN phase_start_time DATETIME DEFAULT CURRENT_TIMESTAMP;
ALTER TABLE game_states ADD COLUMN timeout_seconds INT DEFAULT 60;
```

### 问题 3: 默认值不正确

**症状**: 现有记录的字段值不符合预期

**解决方案**:
```sql
-- 更新现有记录的默认值
UPDATE game_states SET timeout_seconds = 60 WHERE timeout_seconds IS NULL;
```

---

## 📝 后续步骤

迁移完成后，需要：

1. **重启应用**: 确保新字段被加载
2. **验证功能**: 创建测试游戏验证超时功能
3. **监控日志**: 观察超时检测是否正常运行
4. **更新文档**: 记录迁移时间和版本

---

## 📚 相关文档

- [游戏超时功能文档](../docs/timeout_feature.md)
- [Flask-Migrate 文档](https://flask-migrate.readthedocs.io/)
- [Alembic 文档](https://alembic.sqlalchemy.org/)

---

**迁移版本**: v1.0  
**日期**: 2024-01-13  
**状态**: ✅ 待执行
